<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MESH Messenger</title>
    <style>
        :root {
            --mesh-yellow: #fedc03;
            --bg-dark: #121212;
            --bg-card: #1e1e1e;
            --text-main: #ffffff;
            --text-dim: #aaaaaa;
        }

        body {
            background-color: var(--bg-dark);
            color: var(--text-main);
            font-family: 'Courier New', Courier, monospace;
            margin: 0;
            display: flex;
            justify-content: center;
            height: 100vh;
            overflow: hidden;
        }

        #app {
            width: 100%;
            max-width: 600px;
            background-color: var(--bg-card);
            display: flex;
            flex-direction: column;
            border-left: 1px solid #333;
            border-right: 1px solid #333;
        }

        /* Screens */
        .screen { display: none; flex-direction: column; height: 100%; padding: 20px; box-sizing: border-box; }
        .active { display: flex; }

        h1 { color: var(--mesh-yellow); text-transform: uppercase; letter-spacing: 2px; text-align: center; }
        
        /* Forms */
        input {
            background: #000;
            border: 1px solid #333;
            color: var(--mesh-yellow);
            padding: 15px;
            margin-bottom: 10px;
            font-family: inherit;
            outline: none;
        }
        input:focus { border-color: var(--mesh-yellow); }

        button {
            background: var(--mesh-yellow);
            color: #000;
            border: none;
            padding: 15px;
            font-weight: bold;
            cursor: pointer;
            text-transform: uppercase;
        }
        button:hover { opacity: 0.9; }

        /* Chat UI */
        #chat-header {
            border-bottom: 1px solid var(--mesh-yellow);
            padding-bottom: 10px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        #messages-area {
            flex-grow: 1;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 10px;
            padding-right: 5px;
        }

        .message {
            background: #2a2a2a;
            padding: 10px;
            border-radius: 4px;
            max-width: 80%;
            border-left: 3px solid var(--mesh-yellow);
            word-break: break-all;
        }
        
        .message.mine {
            align-self: flex-end;
            border-left: none;
            border-right: 3px solid var(--mesh-yellow);
            background: #333;
        }

        .meta { font-size: 0.7em; color: var(--text-dim); margin-bottom: 4px; }

        #input-area {
            margin-top: 10px;
            display: flex;
            gap: 10px;
        }
        #input-area input { margin-bottom: 0; flex-grow: 1; }

        #status-bar {
            position: fixed;
            bottom: 0; right: 0;
            background: var(--mesh-yellow);
            color: black;
            padding: 2px 5px;
            font-size: 10px;
        }
    </style>
</head>
<body>

<div id="app">
    <!-- Status -->
    <div id="status-bar">Connecting...</div>

    <!-- Login Screen -->
    <div id="login-screen" class="screen active">
        <h1>MESH // NET</h1>
        <p style="text-align:center; color: #666;">Secure. Decentralized. Yellow.</p>
        <input type="text" id="username" placeholder="Username">
        <input type="password" id="password" placeholder="Password">
        <div style="display:flex; gap:10px;">
            <button onclick="doLogin()" style="flex:1;">Login</button>
            <button onclick="doRegister()" style="flex:1; background:#333; color:white;">Register</button>
        </div>
        <p id="auth-error" style="color:red; text-align:center;"></p>
    </div>

    <!-- Channel Select -->
    <div id="channel-screen" class="screen">
        <h1>Select Frequency</h1>
        <input type="text" id="channel-name" placeholder="Channel Name (e.g. general)">
        <input type="password" id="channel-key" placeholder="Encryption Key (Shared Secret)">
        <button onclick="doJoin()">Connect</button>
    </div>

    <!-- Chat Screen -->
    <div id="chat-screen" class="screen">
        <div id="chat-header">
            <span id="header-title">CHANNEL</span>
            <button onclick="location.reload()" style="padding: 5px 10px; font-size: 0.8em;">EXIT</button>
        </div>
        <div id="messages-area"></div>
        <div id="input-area">
            <input type="text" id="msg-input" placeholder="Encrypt & Send...">
            <button onclick="sendMessage()">></button>
        </div>
    </div>
</div>

<script src="clientAPI.js"></script>
<script>
    const api = new MeshAPI();
    let ws = null;

    // Инициализация
    (async () => {
        try {
            const server = await api.findServer();
            document.getElementById('status-bar').innerText = `NODE: ${server}`;
        } catch (e) {
            document.getElementById('status-bar').innerText = "OFFLINE";
            alert("Cannot connect to MESH network.");
        }
    })();

    async function doRegister() {
        const u = document.getElementById('username').value;
        const p = document.getElementById('password').value;
        try {
            await api.register(u, p);
            alert("Registered! Now Login.");
        } catch(e) { document.getElementById('auth-error').innerText = e.message; }
    }

    async function doLogin() {
        const u = document.getElementById('username').value;
        const p = document.getElementById('password').value;
        try {
            await api.login(u, p);
            switchScreen('channel-screen');
        } catch(e) { document.getElementById('auth-error').innerText = "Auth failed"; }
    }

    async function doJoin() {
        const chName = document.getElementById('channel-name').value;
        const chKey = document.getElementById('channel-key').value;
        if(!chName || !chKey) return alert("All fields required");

        // 1. Установка ключа шифрования
        await api.setChannelKey(chKey);

        // 2. Вход в канал (API)
        const data = await api.joinChannel(chName);
        
        // 3. Отображение истории
        const msgArea = document.getElementById('messages-area');
        msgArea.innerHTML = '';
        for(let msg of data.history) {
            await appendMessage(msg);
        }

        // 4. Подключение к WebSocket (Real-time)
        setupWebSocket(chName);

        document.getElementById('header-title').innerText = `#${chName}`;
        switchScreen('chat-screen');
    }

    function setupWebSocket(channelName) {
        const wsUrl = api.baseUrl.replace('http', 'ws');
        ws = new WebSocket(`${wsUrl}/ws/${channelName}/${api.user.id}/${api.user.username}`);
        
        ws.onmessage = async (event) => {
            const msg = JSON.parse(event.data);
            await appendMessage(msg);
        };
    }

    async function sendMessage() {
        const input = document.getElementById('msg-input');
        const text = input.value;
        if(!text) return;

        // Шифруем
        const encrypted = await api.encryptMessage(text);
        
        // Отправляем в WS
        ws.send(JSON.stringify({ content: encrypted }));
        input.value = '';
    }

    async function appendMessage(msg) {
        const area = document.getElementById('messages-area');
        const div = document.createElement('div');
        div.className = 'message ' + (msg.user_id === api.user.id ? 'mine' : '');
        
        // Расшифровываем
        const plainText = await api.decryptMessage(msg.encrypted_content);
        
        div.innerHTML = `
            <div class="meta">${msg.username}</div>
            <div class="content">${escapeHtml(plainText)}</div>
        `;
        area.appendChild(div);
        area.scrollTop = area.scrollHeight;
    }

    function switchScreen(id) {
        document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
        document.getElementById(id).classList.add('active');
    }

    function escapeHtml(text) {
        return text.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;");
    }
</script>
</body>
</html>
